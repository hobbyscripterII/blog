<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.blog.board.BoardMapper">
  <select id="getBoard" parameterType="BoardGetDto" resultType="BoardGetVo">
    SELECT
      ROW_NUMBER() OVER (ORDER BY B.CREATED_AT DESC) AS ROW_NUM,
      B.IBOARD                              AS IBOARD,
      B.ICODE                               AS ICODE,
      C.NAME                                AS BOARD_NAME,
      B.TITLE                               AS TITLE,
      A.NAME                                AS USER_NAME,
      IFNULL(T.NAME      , '')              AS THUMBNAIL,
      IFNULL(B.YOUTUBE_ID, '')              AS YOUTUBE_ID,
      DATE_FORMAT(B.CREATED_AT, '%Y-%m-%d') AS CREATED_AT,
      B.SEC_YN                              AS SEC_YN,
      B.DEL_YN                              AS DEL_YN
    FROM TBL_BOARD B
    INNER JOIN TBL_CODE     C  ON B.ICODE  = C.ICODE
    LEFT JOIN TBL_THUMBNAIL T  ON B.IBOARD = T.IBOARD
    LEFT JOIN TBL_ADMIN     A  ON B.IADMIN = A.IADMIN
    <where>
      B.DEL_YN = 'N'
      <if test="role != 'ADMIN'">
        AND B.SEC_YN = 'N'
      </if>
      <if test="icode != null and icode != ''">
        AND B.ICODE = #{icode}
      </if>
      <if test="search != null and search != ''">
        AND (
              B.TITLE    LIKE CONCAT('%', #{search}, '%') OR
              B.CONTENTS LIKE CONCAT('%', #{search}, '%')
          )
      </if>
    </where>
    GROUP BY B.IBOARD
    ORDER BY B.CREATED_AT DESC
    LIMIT #{offset}, #{amount}
  </select>
  
  <select id="selBoard" parameterType="BoardSelDto" resultType="BoardSelVo">
    SELECT 
      B.IBOARD,
      B.ICODE,
      B.TITLE,
      B.CONTENTS,
      IFNULL(B.YOUTUBE_ID, '') AS YOUTUBE_ID,
      IFNULL(TH.NAME     , '') AS THUMBNAIL,
      B.CREATED_AT,
      B.SEC_YN
    FROM TBL_BOARD B
    LEFT JOIN TBL_THUMBNAIL TH ON B.IBOARD = TH.IBOARD
    WHERE B.IBOARD = #{iboard}
  </select>
  
  <select id="getBoardCnt" parameterType="BoardGetDto" resultType="int">
    SELECT COUNT(DISTINCT B.IBOARD)
    FROM TBL_BOARD B
    <where>
      B.DEL_YN = 'N'
      <if test="role != 'ADMIN'">
        AND B.SEC_YN = 'N'
      </if>
      <if test="icode != null and icode != ''">
        AND B.ICODE = #{icode}
      </if>
      <if test="search != null and search != ''">
        AND (
              B.TITLE     LIKE CONCAT('%', #{search}, '%') OR
              B.CONTENTS  LIKE CONCAT('%', #{search}, '%') OR
              TA.TAG_NAME LIKE CONCAT('%', #{search}, '%')
             )
      </if>
    </where>
  </select>
</mapper>