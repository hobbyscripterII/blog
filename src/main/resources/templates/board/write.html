<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default-layout}"
      layout:fragment="section">
<section>
    <div class="title" th:text="${title}">TITLE</div>
    <table class="table table-post-read" th:object="${dto}">
        <tr>
            <td class="td-info">제목</td>
            <td colspan="2"><input type="text" id="title" th:field="*{title}" class="form-control"></td>
        </tr>
<!--        <tr>-->
<!--            <td class="td-info">태그</td>-->
<!--            <td colspan="2"><input type="text" id="tag" class="form-control"></td>-->
<!--        </tr>-->
        <tr>
            <td class="td-info"></td>
            <td colspan="3"><div class="form-control" id="tag-list"><div id="tag-list-child"></div></div></td>
        </tr>
        <tr>
            <td class="td-info">내용</td>
            <td class="td-contents">
                <!-- textarea 공백 있으면 공백도 렌더링됨 -->
                <textarea class="form-control" th:field="*{contents}" style="resize: none; height: 80vh"></textarea>
            </td>
            <td class="td-contents">
                <div class="form-control" id="div-markdown"></div>
            </td>
        </tr>
    </table>

    <div class="div-btn-wrap">
        <!-- 추후 수정 필요 -->
        <!-- iboard x - 게시글 등록 시에는 dto 값이 전부 null이므로 x, iboard o - 게시글 수정 시 iboard를 갖고오므로 o -->
        <th:block th:if="${dto.iboard == 0}">
            <button type="button" class="btn btn-success" onclick="insPost()">등록</button>
        </th:block>
        <th:block th:if="${dto.iboard != 0}">
            <button type="button" class="btn btn-info" onclick="updPost()">수정</button>
        </th:block>
    </div>
</section>

<script th:inline="javascript">
    const contents = $('#contents');
    contents.keyup(function() {
        document.getElementById('div-markdown').innerHTML = marked.parse(contents.val());
    });

    // const tag = $('#tag');
    // tag.keyup(function() {
    //     $('#tag-list-child *').remove();
    //
    //     $.ajax({
    //         type: 'get',
    //         url: '/board/tag',
    //         data: {"tag" : tag.val()},
    //         success: function (data) {
    //             console.log("data.length = ", data.length);
    //             console.log("data = ", data);
    //
    //             $('#tag-list').css('display', 'block');
    //             data.forEach(function(data, idx) {
    //                 // $('#tag-list-child').prepend('div-tag-' + idx);
    //                 $('#tag-list-child').append(data.name);
    //                 // $('.div-tag-' + idx).html(data.name);
    //             })
    //         }
    //     })
    // });

    function insPost() {
        const dto = {
            "isubject" : [[${subject}]],
            "title" : $('#title').val(),
            "contents" : $('#contents').val()
        };

        $.ajax({
            type: 'post',
            url: '/board/write',
            contentType: "application/json",
            data: JSON.stringify(dto),
            success: function (iboard) {
                console.log(iboard);
                if (iboard !== 0) {
                    if(confirm('게시글 등록이 완료되었습니다. 등록된 게시글을 확인하시겠습니까?')) {
                        location.href='/board/read?subject=' + [[${subject}]] + '&board=' + iboard;
                    } else {
                        location.href='/board/list?subject=' + [[${subject}]]
                    }
                } else {
                    alert("게시글 등록에 실패하였습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    }

    function updPost() {
        const dto = {
            "iboard" : [[${dto.iboard}]],
            "title" : $('#title').val(),
            "contents" : $('#contents').val()
        };

        $.ajax({
            type: 'put',
            url: '/board',
            contentType: "application/json",
            data: JSON.stringify(dto),
            success: function (iboard) {
                console.log(iboard);
                if (iboard !== 0) {
                    if(confirm('게시글 수정이 완료되었습니다. 수정된 게시글을 확인하시겠습니까?')) {
                        location.href='/board/read?subject=' + [[${dto.isubject}]] + '&board=' + iboard;
                    } else {
                        location.href='/board/list?subject=' + [[${dto.isubject}]]
                    }
                } else {
                    alert("게시글 수정에 실패하였습니다. 잠시 후 다시 시도해주세요.");
                }
            }
        });
    }
</script>
</html>